---
title: "Simulating contact tracing data"
author: "Thibaut Jombart"
output:
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.width = 8, fig.height = 6, dpi = 70)
```




# Data simulation

## Simulated distributions

### Incubation period

```{r }

library(distcrete)
library(epitrix)
library(tidyverse)

incub_mu <- 9.4
incub_sd <- 7.4

params <- gamma_mucv2shapescale(incub_mu,
                                      incub_sd / incub_mu)

incubation <- distcrete("gamma",
                        interval = 1,
                        shape = params$shape,
                        scale = params$scale)

```

Example:

```{r }

incubation$r(1000) %>%
  qplot() +
  theme_bw() +
  labs(x = "Incubation time",
       y = "Frequency")

```



### Duration of exposures

Duration is drawn from a distribution $~ 1 + Exp(d - 1)$ where $d$ is the mean
duration of exposure (must be at least 1).

```{r }

duration_r <- function(n, mean = 1) {
  if (mean < 1) {
    msg <- "mean duration of exposure must be >=1 day"
    stop(msg)
  }
  
  1 + rpois(n, mean - 1)
}

```

Example:

```{r }

duration_r(1000, mean = 2.5) %>%
  qplot() +
  theme_bw() +
  labs(x = "Duration of exposure",
       y = "Frequency")

```



### Dates of exposures

Date of exposure are drawn from a Uniform distribution on a given time-frame:

```{r }

date_exposure_r <- function(n, min = 0L, max = 30L, mean_duration = 1) {
  base <- seq(from = min, to = max, by = 1L)
  L <- length(base)
  date_start <- base[sample.int(L, size = n, replace = TRUE)]
  durations <- duration_r(n, mean_duration)
  data.frame(
      id = 1:n,
      exposure_start = date_start,
      exposure_end = date_start + durations - 1,
      exposure_duration = durations
  )
}

```

Example:

```{r }

toy_data <- date_exposure_r(10, mean_duration = 1.5)
toy_data

toy_data %>%
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = id)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  theme_bw() +
  guides(color = FALSE) +
  labs(x = "Exposure windows", y = "Contact ID")

```



### Infection of contacts

The infection of contacts is determined as follows:

1. determine the probability of infection given the rate of infectious contacts
2. determine if there is an infection using a Binomial (Bernoulli) distribution
3. determine the day of the infection from the window of exposure
4. determine the day of symptom onset from the incubation time distribution

```{r }


sample_ <- function(x, n = length(x), replace = FALSE) {
  x[sample.int(length(x), n, replace = replace)]
}

pick_exposure <- function(start, end) {
  vapply(seq_along(start),
         function(i) sample_(start[i]:end[i], 1L),
         1L)
}

#' @param x contact data as returned by `date_exposure_r`
#'
#' @param rate_infection a positive rate of infection per day of contact
#'
#' @param incubation_time a function simulating incubation times whose only
#'   argument is `n`, the number of simulated incubation times
#' 
infect_contacts <- function(x,
                            rate_infection = 0,
                            incubation_time = incubation$r) {

  out <- mutate(
      x,
      p_infection = 1 - exp(-rate_infection * exposure_duration),
      rnd = runif(n()),
      case = if_else(rnd < p_infection, "case", "non_case"),
      case = factor(case, levels = c("case", "non_case")),
      date_infection = if_else(
          case == "case",
          pick_exposure(exposure_start, exposure_end),
          NA_integer_),
      date_onset = if_else(
          case == "case",
          as.integer(date_infection + incubation_time()),
          NA_integer_))

  select(out, -rnd)
}

```

Example:

```{r }

toy_data <- infect_contacts(toy_data, rate_infection = 0.7)
toy_data

toy_data %>%
  pivot_longer(cols = date_infection:date_onset,
               names_to = "event",
               values_to = "event_date") %>%
  mutate(event = sub("date_", "", event)) %>% 
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = case)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  geom_point(aes(x = event_date, shape = event), size = 4) +
  scale_shape_manual(values = c(infection = 4, onset = 1)) +
  theme_bw() +
  labs(x = "Time", y = "Contact ID")

```



## Simulator

The contact data simulator assembles the various components of the functions
above, and outputs S3 objects with class `contact_data`.

```{r }

#' Simulate contact tracing data
#' 
#' @param n the number of contacts to simulate
#' 
#' @param rate_infection a positive rate of infection per day of contact
#'
#' @param
#'

simulate_contacts <- function(n,
                              incubation,
                              rate_infection = 0,
                              exposure_mean_duration = 1,
                              exposure_min_date = 0,
                              exposure_max_date = 30
                              ) {

  out <- date_exposure_r(n = n,
                         min = exposure_min_date,
                         max = exposure_max_date,
                         mean_duration = exposure_mean_duration)
  
  out <- infect_contacts(out, rate_infection = rate_infection)
  out <- tibble(out)
  class(out) <- c("contact_data", class(out))
  out
}


plot.contact_data <- function(x) {
  
  pivot_longer(x,
               cols = date_infection:date_onset,
               names_to = "event",
               values_to = "event_date") %>%
  mutate(event = sub("date_", "", event)) %>% 
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = case)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  geom_point(aes(x = event_date, shape = event), size = 4) +
  scale_shape_manual(values = c(infection = 4, onset = 1)) +
  theme_bw() +
  labs(x = "Time", y = "Contact ID")
}

```

Example:

```{r }

x <- simulate_contacts(50,
                       incubation = incubation$r,
                       rate_infection = .2,
                       exposure_mean_duration = 5)
x
plot(x)

```





# Contact tracing simulation

## Random follow-up

In this section we devise a function which will process a `contact_data` object
and simulate follow-up over time using a random strategy.

### Adding followup window

This function adds to variables to indicate when followup must start and end (both dates inclusive).
```{r }

add_followup <- function(x, followup_duration) {
  mutate(x,
         followup_start = exposure_end + 1,
         followup_end = followup_start + followup_duration - 1)
}

x <- x %>%
  add_followup(21)
x

```


### Finding active contacts

```{r }

active_contacts <- function(x, t, filter = TRUE) {
  out <- mutate(x,
                active = t >= followup_start & t <= followup_end)
  if (filter) {
    out <- filter(out, active)
    out <- select(out, -active)
  }
  out
}


```

Example:

```{r }

x %>%
  active_contacts(5, filter = FALSE)

x %>%
  active_contacts(10)

x %>%
  active_contacts(10) %>%
  plot()

```



### Random followup strategy

```{r }

#' @param x a `contact_data` object
#'
#' @param t current time of followup
#'
#' @param coverage the proportion of contacts followed

random_followup <- function(x, t, coverage, followup_only = FALSE) {
  
  out <- active_contacts(x, t, filter = FALSE)

  out <- mutate(out,
                followup = sample(c("seen", "missed"),
                                  n(),
                                  replace = TRUE,
                                  prob = c(coverage, 1 - coverage)),
                followup = if_else(active, followup, "inactive"),
                followup = if_else(followup == "seen" &
                                   t == date_onset &
                                   case == "case",
                                   "detected",
                                   followup))
  out <- rename(out, !!paste("followup", t, sep = "_") := followup)
  out <- select(out, -active)
  if (followup_only) {
    out <- select(out, !!paste("followup", t, sep = "_"))
  }
  out
}

```

Example:

```{r }

# 50% contacts followed on day 10
random_followup(x, 10, 0.5)
random_followup(x, 10, 0.5) %>%
  count(followup_10)

```

All followup from day 1 to 30:

```{r }

days <- seq(from = min(x$followup_start), to = max(x$followup_end), by = 1L)

res_random <- lapply(days, function(t) random_followup(x, t, 0.5, TRUE)) %>%
  bind_cols() %>%
  rownames_to_column("id") %>%
  pivot_longer(-1, names_to = "time", values_to = "followup") %>%
  mutate(
      time = gsub("followup_", "", time), time = as.integer(time),
      followup = factor(followup, levels = c("inactive", "seen", "missed", "detected")))
res_random


## general graph
res_random %>%
  count(time, followup) %>%
  ggplot(aes(x = time, y = n)) +
  geom_col(aes(fill = followup)) +
  theme_bw() +
  labs(x = "time",
       y = "number of contacts",
       title = "Contact followup")

## with only active contacts
res_random %>%
  filter(followup != "inactive") %>% 
  count(time, followup) %>%
  ggplot(aes(x = time, y = n)) +
  geom_col(aes(fill = followup)) +
  theme_bw() +
  labs(x = "time",
       y = "number of contacts",
       title = "Contact followup",
       subtitle = "only active contacts")

```
