---
title: "Simulating contact tracing data"
author: "Thibaut Jombart"
output:
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, fig.width = 8, fig.height = 6, dpi = 70)
```




# Data simulation

## Simulated distributions

### Incubation period

```{r }

library(distcrete)
library(epitrix)
library(tidyverse)

incub_mu <- 9.4
incub_sd <- 7.4

params <- gamma_mucv2shapescale(incub_mu,
                                      incub_sd / incub_mu)

incubation <- distcrete("gamma",
                        interval = 1,
                        shape = params$shape,
                        scale = params$scale)

```

Example:

```{r }

incubation$r(1000) %>%
  qplot() +
  theme_bw() +
  labs(x = "Incubation time",
       y = "Frequency")

```



### Duration of exposures

Duration is drawn from a distribution $~ 1 + Exp(d - 1)$ where $d$ is the mean
duration of exposure (must be at least 1).

```{r }

duration_r <- function(n, mean = 1) {
  if (mean < 1) {
    msg <- "mean duration of exposure must be >=1 day"
    stop(msg)
  }
  
  1L + rpois(n, mean - 1)
}

```

Example:

```{r }

duration_r(1000, mean = 2.5) %>%
  qplot() +
  theme_bw() +
  labs(x = "Duration of exposure",
       y = "Frequency")

```



### Dates of exposures

Date of exposure are drawn from a Uniform distribution on a given time-frame:

```{r }

date_exposure_r <- function(n, min = 0L, max = 30L, mean_duration = 1) {
  base <- seq(from = min, to = max, by = 1L)
  L <- length(base)
  date_start <- base[sample.int(L, size = n, replace = TRUE)]
  durations <- duration_r(n, mean_duration)
  data.frame(
      id = as.integer(1:n),
      exposure_start = as.integer(date_start),
      exposure_end = as.integer(date_start + durations - 1),
      exposure_duration = as.integer(durations)
  )
}

```

Example:

```{r }

toy_data <- date_exposure_r(10, mean_duration = 1.5)
toy_data

toy_data %>%
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = id)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  theme_bw() +
  guides(color = FALSE) +
  labs(x = "Exposure windows", y = "Contact ID")

```



### Infection of contacts

The infection of contacts is determined as follows:

1. determine the probability of infection given the rate of infectious contacts
2. determine if there is an infection using a Binomial (Bernoulli) distribution
3. determine the day of the infection from the window of exposure
4. determine the day of symptom onset from the incubation time distribution

```{r }


sample_ <- function(x, n = length(x), replace = FALSE) {
  x[sample.int(length(x), n, replace = replace)]
}

pick_exposure <- function(start, end) {
  vapply(seq_along(start),
         function(i) sample_(start[i]:end[i], 1L),
         1L)
}

#' @param x contact data as returned by `date_exposure_r`
#'
#' @param rate_infection a positive rate of infection per day of contact
#'
#' @param incubation_time a function simulating incubation times whose only
#'   argument is `n`, the number of simulated incubation times
#' 
infect_contacts <- function(x,
                            rate_infection = 0,
                            incubation_time = incubation$r) {

  out <- mutate(
      x,
      p_infection = 1 - exp(-rate_infection * exposure_duration),
      rnd = runif(n()),
      case = if_else(rnd < p_infection, "case", "non_case"),
      case = factor(case, levels = c("case", "non_case")),
      date_infection = if_else(
          case == "case",
          pick_exposure(exposure_start, exposure_end),
          NA_integer_),
      date_onset = if_else(
          case == "case",
          as.integer(date_infection + incubation_time()),
          NA_integer_))

  select(out, -rnd)
}

```

Example:

```{r }

toy_data <- infect_contacts(toy_data, rate_infection = 0.7)
toy_data

toy_data %>%
  pivot_longer(cols = date_infection:date_onset,
               names_to = "event",
               values_to = "event_date") %>%
  mutate(event = sub("date_", "", event)) %>% 
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = case)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  geom_point(aes(x = event_date, shape = event), size = 4) +
  scale_shape_manual(values = c(infection = 4, onset = 1)) +
  theme_bw() +
  labs(x = "Time", y = "Contact ID")

```



## Simulator

The contact data simulator assembles the various components of the functions
above, and outputs S3 objects with class `contact_data`.

```{r }

#' Simulate contact tracing data
#' 
#' @param n the number of contacts to simulate
#' 
#' @param rate_infection a positive rate of infection per day of contact
#'
#' @param
#'

simulate_contacts <- function(n,
                              incubation,
                              rate_infection = 0,
                              exposure_mean_duration = 1,
                              exposure_min_date = 0,
                              exposure_max_date = 30
                              ) {

  out <- date_exposure_r(n = n,
                         min = exposure_min_date,
                         max = exposure_max_date,
                         mean_duration = exposure_mean_duration)
  
  out <- infect_contacts(out, rate_infection = rate_infection)
  out <- tibble(out)
  class(out) <- c("contact_data", class(out))
  out
}


plot.contact_data <- function(x) {
  
  pivot_longer(x,
               cols = date_infection:date_onset,
               names_to = "event",
               values_to = "event_date") %>%
  mutate(event = sub("date_", "", event)) %>% 
  mutate(id = factor(id)) %>%
  ggplot(aes(x = exposure_start, y = id, color = case)) +
  geom_segment(aes(xend = exposure_end, yend = id)) +
  geom_point() +
  geom_point(aes(x = exposure_end)) +
  geom_point(aes(x = event_date, shape = event), size = 4) +
  scale_shape_manual(values = c(infection = 4, onset = 1)) +
  theme_bw() +
  labs(x = "Time", y = "Contact ID")
}

```

Example:

```{r }

x <- simulate_contacts(50,
                       incubation = incubation$r,
                       rate_infection = .2,
                       exposure_mean_duration = 5)
x
plot(x)

```





# Contact tracing simulation

## Random follow-up

In this section we devise a function which will process a `contact_data` object
and simulate follow-up over time using a random strategy.

### Adding followup window

This function adds to variables to indicate when followup must start and end (both dates inclusive).
```{r }

add_followup <- function(x, followup_duration) {
  mutate(x,
         followup_start = as.integer(exposure_end + 1L),
         followup_end = as.integer(followup_start + followup_duration - 1L))
}

x <- x %>%
  add_followup(21)
x

```


### Finding active contacts

Active contacts are contacts which, at time *t*:

* have not been detected yet
* are within the followup window

```{r }

active_contacts <- function(x, t, filter = TRUE) {
  if (!"detected" %in% names(x)) {
    x <- mutate(x, detected = rep(FALSE, n()))
  }
 
  out <- mutate(x,
                active =
                  t >= followup_start &
                  t <= followup_end &
                  !detected)
  if (filter) {
    out <- filter(out, active)
    out <- select(out, -active)
  }
  out
}


```

Example:

```{r }

x %>%
  active_contacts(5, filter = FALSE)

x %>%
  active_contacts(10)

x %>%
  active_contacts(10) %>%
  plot()

```



### Random followup strategy

```{r }

#' @param x a `contact_data` object
#'
#' @param t current time of followup
#'
#' @param coverage the proportion of contacts followed

random_followup <- function(x, t, coverage, followup_only = FALSE) {

  ## add variables as needed
  t <- as.integer(t)

  ## add needed variables on followup history if they are missing
  ## * last_seen: needed to define 'detected' cases
  ## * detected: needed to ignore already detected cases
  if (!"last_seen" %in% names(x)) {
    x <- mutate(x, last_seen = rep(-1L, n()))
  }
  if (!"detected" %in% names(x)) {
    x <- mutate(x, detected = rep(FALSE, n()))
  }
  if (!"detected_at" %in% names(x)) {
    x <- mutate(x, detected_at = rep(NA_integer_, n()))
  }

  ## check active contacts
  out <- active_contacts(x, t, filter = FALSE)


  ## strategy:
  ## 1. determine the number of contacts followed at time t  
  ## 2. determine which contacts are still active
  ## 3. select followed contacts from active ones

  active_id <- pull(filter(out, active), id)
  n_followed <- rbinom(1, nrow(out), coverage)
  n_followed <- min(length(active_id), n_followed)
  id_followed <- sample_(active_id, n_followed, replace = FALSE)
  
  ## add followup info
  out <- mutate(
      out,
      followup = if_else(id %in% id_followed,
                         "seen",
                         "missed"),
      followup = if_else(active, followup, "inactive"),
      followup = if_else(followup == "seen" &
                         t >= date_onset &
                         last_seen < date_onset &
                         case == "case",
                         "detected",
                         followup),
      detected = if_else(followup == "detected",
                         TRUE,
                         detected),
      detected_at = if_else(followup == "detected",
                         t,
                         detected_at),
      last_seen = if_else(followup %in% c("detected", "seen"),
                          t,
                          last_seen)
      )
  out <- rename(out, !!paste("followup", t, sep = "_") := followup)
  out <- select(out, -active)
  if (followup_only) {
    out <- select(out, !!paste("followup", t, sep = "_"))
  }
  out
}

```

Example:

```{r }

# 50% contacts followed on day 10
random_followup(x, 10, 0.5)
random_followup(x, 10, 0.5) %>%
  count(followup_10)

```

All followup from day 1 to 30:

```{r }

days <- seq(from = min(x$followup_start), to = max(x$followup_end), by = 1L)

previous_followup <- x
for (i in seq_along(days)) {
  res_random <- random_followup(previous_followup,
                                t = days[i],
                                0.01,
                                FALSE)
  previous_followup <- res_random
}

res_random_simple <- res_random %>%
  select(id, contains("followup"), -followup_start, -followup_end) %>% 
  pivot_longer(-1, names_to = "time", values_to = "followup") %>%
  mutate(
      time = gsub("followup_", "", time), time = as.integer(time),
      followup = factor(followup, levels = c("inactive", "seen", "missed", "detected")))
res_random_simple


## color scale
scale_fill_followup <- scale_fill_manual(
    values = c(inactive = "#C4B5B2",
               detected = "#B74967",
               seen = "#49A0D5",
               missed = "#ECBF74")
)


## graph of followup over time
res_random_simple %>%
  count(time, followup) %>%
  ggplot(aes(x = time, y = n)) +
  geom_col(aes(fill = followup)) +
  theme_bw() +
  scale_fill_followup +
  labs(x = "time",
       y = "number of contacts",
       title = "Contact followup")

## with only active contacts
res_random_simple %>%
  filter(followup != "inactive") %>% 
  count(time, followup) %>%
  ggplot(aes(x = time, y = n)) +
  geom_col(aes(fill = followup)) +
  theme_bw() +
  scale_fill_followup +
  labs(x = "time",
       y = "number of contacts",
       title = "Contact followup",
       subtitle = "only active contacts")


## proportion of cases detected
res_random %>%
  filter(case == "case") %>%
  summarise(p_detected = mean(detected))

## delay to detection
res_random_delay <- res_random %>%
  filter(case == "case") %>%
  transmute(delay_detection = detected_at - date_onset)

res_random_delay %>%
  summary()

res_random_delay %>%
  ggplot(aes(x = delay_detection)) +
  geom_density(color = "#ECBF74", fill = "#ECBF74", alpha = .6) +
  theme_bw() +
  labs(x = "Days from onset to detection",
       y = "Frequency",
       title = "Distribution of delay to detection")

```
